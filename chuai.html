<!DOCTYPE html>
<html>
<head>
  <title>æ¢­å“ˆæ¸¸æˆ</title>
  <style>
   

    body { background: #2c3e50; color: white; font-family: Arial; }
    .container { display: flex; justify-content: space-around; padding: 20px; }
    .player-area, .dealer-area { width: 45%; border: 2px solid #3498db; padding: 10px; }
    .cards { display: flex; gap: 10px; margin: 10px 0; }
    .card { width: 80px; height: 120px; background: white; border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; color: black; }
    .hidden { background: #3498db; color: white; }
    .controls { margin-top: 20px; }
    button { padding: 10px; margin: 5px; cursor: pointer; }
    .chip-count { font-size: 20px; }

  
  .poker-card {
    width: 80px;
    height: 120px;
    position: relative;
    perspective: 1000px;
    cursor: pointer;
    margin: 15px;
    transition: transform 0.3s;
  }
  
  /* æ‚¬åœæ”¾å¤§æ•ˆæœ */
  .poker-card:hover {
    transform: scale(1.05);
  }
  
  /* æ­£åé¢é€šç”¨æ ·å¼ */
  .card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 12px;
    backface-visibility: hidden;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background: #fff;
  }
  
  /* å¡ç‰‡æ­£é¢ */
  .card-front {
    transform-style: preserve-3d;
  }
  
  /* å¡ç‰‡èƒŒé¢ï¼ˆé»˜è®¤ç¿»è½¬çŠ¶æ€ï¼‰ */
  .card-back {
    transform: rotateY(180deg);
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  }
  
  /* ç¿»è½¬åŠ¨ç”» */
  .poker-card.flipped .card-front {
    transform: rotateY(-180deg);
  }
  
  .poker-card.flipped .card-back {
    transform: rotateY(0deg);
  }
  
  /* æ‰‘å…‹ç‰Œæ•°å­—/å­—æ¯æ ·å¼ */
  .card-corner {
    position: absolute;
    font-size: 1.8em;
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
  }
  
  .top-left {
    top: 12px;
    left: 12px;
    text-align: left;
  }
  
  .bottom-right {
    bottom: 12px;
    right: 12px;
    transform: rotate(180deg);
  }
  
  /* èŠ±è‰²é¢œè‰² */
  .red { color: #e74c3c; }
  .black { color: #2c3e50; }
  
  /* ä¸­å¿ƒèŠ±è‰²å›¾æ¡ˆ */
  .center-suit {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 80px;
    opacity: 0.9;
  }
  
  /* å¡ç‰‡èƒŒé¢å›¾æ¡ˆ */
  .card-back::before {
    content: "";
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    background: repeating-linear-gradient(
      45deg,
      rgba(255,255,255,0.1),
      rgba(255,255,255,0.1) 10px,
      rgba(0,0,0,0.05) 10px,
      rgba(0,0,0,0.05) 20px
    );
    border-radius: 8px;
    border: 3px solid rgba(255,255,255,0.2);
  }
  
  /* ç‰¹æ®Šå¡ç‰‡æ ·å¼ï¼ˆä¾‹å¦‚é¬¼ç‰Œï¼‰ */
  .joker-card .center-suit {
    font-size: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .joker-card .center-suit::after {
    content: "JOKER";
    font-size: 24px;
    margin-top: 10px;
    letter-spacing: 2px;
  }
</style>

</head>
<body>
  <div class="container">
    <!-- ç©å®¶åŒºåŸŸ -->
    <div class="player-area">
      <h2>ç©å®¶ (ç­¹ç : <span id="playerChips">1000</span>)</h2>
      <div class="cards" id="playerCards"></div>
      <div class="controls" id="playerControls"></div>
    </div>

    <!-- åº„å®¶åŒºåŸŸ -->
    <div class="dealer-area">
      <h2>åº„å®¶ (ç­¹ç : <span id="dealerChips">5000</span>)</h2>
      <div class="cards" id="dealerCards"></div>
    </div>
     <!-- é»‘æ¡ƒç‰Œç¤ºä¾‹ -->
  <!-- <div class="poker-card" onclick="this.classList.toggle('flipped')">
    <div class="card-face card-front">
      <div class="card-corner top-left black">Aâ™ </div>
      <div class="center-suit black">â™ </div>
      <div class="card-corner bottom-right black">Aâ™ </div>
    </div>
    <div class="card-face card-back"></div>
  </div>
  çº¢å¿ƒç‰Œç¤ºä¾‹ -->
  <!-- <div class="poker-card" onclick="this.classList.toggle('flipped')">
    <div class="card-face card-front">
      <div class="card-corner top-left red">10â™¥</div>
      <div class="center-suit red">â™¥</div>
      <div class="card-corner bottom-right red">10â™¥</div>
    </div>
    <div class="card-face card-back"></div>
  </div> -->
  <!-- é¬¼ç‰Œç¤ºä¾‹ -->
  <!-- <div class="poker-card joker-card" onclick="this.classList.toggle('flipped')">
    <div class="card-face card-front">
      <div class="card-corner top-left red">JOKER</div>
      <div class="center-suit red">ğŸ¤¡</div>
      <div class="card-corner bottom-right red">JOKER</div>
    </div>
    <div class="card-face card-back"></div> -->
  </div>
  </div>
  <script type="module">
    import { io } from "https://cdn.socket.io/4.7.4/socket.io.esm.min.js";
        // åŠ å…¥æˆ¿é—´
    const socket = io(); //wsçš„åœ°å€

    socket.emit('join-room', 'room1');

    // ç›‘å¬æ¸¸æˆçŠ¶æ€æ›´æ–°
    debugger
    socket.on('game-update', (state) => {
    debugger
    // renderGame(state);
});
    
    </script>
 
<script>

// ================== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==================
class ShowHandGame {
  constructor() {
    this.deck = [];
    this.player = { chips: 1000, cards: [] };
    this.dealer = { chips: 5000, cards: [] };
    this.currentBet = 0;
    this.gamePhase = 'betting'; // betting, dealing, showdown
  }

  // åˆå§‹åŒ–æ–°æ¸¸æˆ
  initGame() {
    this.generateDeck();
    this.shuffleDeck();
    this.player.cards = [];
    this.dealer.cards = [];
    this.currentBet = 0;
    this.updateUI();
    this.proceedGame()
    this.proceedGame()
  }

  // ç”Ÿæˆç‰Œå †
  generateDeck() {
    const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
    // const ranks = Array.from({length: 13}, (_, i) => i + 2); // 2-14
    const ranks =[8,9,10,11,12,13]
    this.deck = [];
    for (let suit of suits) {
      for (let rank of ranks) {
        this.deck.push({ suit, rank });
      }
    }
  }

  // æ´—ç‰Œ
  shuffleDeck() {
    for (let i = this.deck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
    }
  }

  // å‘ç‰Œ
  dealCard(target) {
    const card = this.deck.pop();
    target.cards.push(card);
    this.updateUI();
  }

  // ç©å®¶ä¸‹æ³¨
  placeBet(amount) {
    if (this.player.chips < amount) return false;
    this.player.chips -= amount;
    this.currentBet += amount;
    return true;
  }

  // å…¨æŠ¼
  allIn() {
    const bet = this.player.chips;
    this.placeBet(bet);
  }

  // æ›´æ–°ç•Œé¢
  updateUI() {
    // æ›´æ–°ç­¹ç æ˜¾ç¤º
    document.getElementById('playerChips').textContent = this.player.chips;
    document.getElementById('dealerChips').textContent = this.dealer.chips;

    // æ¸²æŸ“å¡ç‰Œ
    this.renderCards('playerCards', this.player.cards);
    this.renderCards('dealerCards', this.dealer.cards, true);

    // æ§åˆ¶æŒ‰é’®
    this.renderControls();
  }

  // æ¸²æŸ“å¡ç‰Œ
  renderCards(containerId, cards, isDealer = false) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    cards.forEach((card, index) => {
      const div = document.createElement('div');
      // ['â™ ', 'â™¥', 'â™¦', 'â™£'];
      let huase= 'red'
      let content=card.rank
      if(content==11){
        content='j'
      }
      if(content==12){
        content='Q'
      }
      if(content==13){
        content='K'
      }
      if(card.suit=='â™ '||card.suit=='â™£'){
        huase= 'black'
      }
      if(isDealer && index < 2 ){
        content=''
        card.suit=''
      }
      // div.className = `card ${isDealer && index === 0 ? 'hidden' : ''}`;
      // div.textContent = isDealer && index === 0 ? '?' : `${card.rank}${card.suit}`;
      div.innerHTML=`<div class="poker-card">
      <div class="card-face card-front">
      <div class="card-corner top-left `+huase+`">`+content+card.suit+`</div>
      <div class="center-suit `+huase+`">`+card.suit+`</div>
      <div class="card-corner bottom-right `+huase+`">`+content+card.suit+`</div>
      </div>
        <div class="card-face card-back"></div>
      </div>`
      container.appendChild(div);
    });
  }

  // æ¸²æŸ“æ§åˆ¶æŒ‰é’®
  renderControls() {
    const controls = document.getElementById('playerControls');
    controls.innerHTML = '';
    
    if (this.gamePhase === 'betting') {
      [1, 2, 3].forEach(amount => {
        const button = document.createElement('button');
        button.textContent = `è·Ÿè¸¹ ${amount}`;
        button.onclick = () => this.handleBet(amount);
        controls.appendChild(button);
      });
      [10, 20, 30].forEach(amount => {
        const button = document.createElement('button');
        button.textContent = `é£› ${amount}`;
        button.onclick = () => this.handleBet(amount);
        controls.appendChild(button);
      });
      const allInButton = document.createElement('button');
      allInButton.textContent = 'é£›';
      allInButton.onclick = () => this.handleAllIn();
      controls.appendChild(allInButton);
    }
  }

  // å¤„ç†ä¸‹æ³¨
  handleBet(amount) {
    if (this.placeBet(amount)) {
      this.proceedGame();
    }
  }

  // å¤„ç†å…¨æŠ¼
  handleAllIn() {
    this.allIn();
    this.proceedGame();
  }

  // æ¸¸æˆæµç¨‹æ§åˆ¶
  proceedGame() {
    if (this.player.cards.length < 5) {
      this.dealCard(this.player);
      this.dealCard(this.dealer);
    }
    // ç®€åŒ–çš„è‡ªåŠ¨åº„å®¶é€»è¾‘
    if (this.player.cards.length === 5) {
      this.resolveGame()
    }
  } 

  // ç»“ç®—æ¸¸æˆ
  resolveGame() {
    const playerHand = this.evaluateHand(this.player.cards);
    const dealerHand = this.evaluateHand(this.dealer.cards);
    
    if (playerHand.type > dealerHand.type) {
      this.player.chips += this.currentBet * 2;
      console.log('ç©å®¶èƒœåˆ©!');
    } else {
      console.log('åº„å®¶èƒœåˆ©!');
    }

    // this.initGame();
  }

  // ç‰Œå‹è¯„ä¼°ï¼ˆåŒä¹‹å‰å®ç°ï¼‰


  evaluateHand(cards) {
    const ranks = cards.map(c => c.rank).sort((a, b) => a - b);
    const suits = cards.map(c => c.suit);
    
    // è¾…åŠ©å‡½æ•°ï¼šç»Ÿè®¡ç‚¹æ•°å‡ºç°æ¬¡æ•°
    const countRanks = () => {
      let count = {};
      ranks.forEach(r => count[r] = (count[r] || 0) + 1);
      return Object.values(count).sort((a,b) => b - a);
    };

    // åˆ¤æ–­æ˜¯å¦é¡ºå­
    const isStraight = () => {
      // å¤„ç†A-2-3-4-5çš„ç‰¹æ®Šæƒ…å†µ
      if (ranks.join(',') === '2,3,4,5,14') return true;
      for (let i = 1; i < ranks.length; i++) {
        if (ranks[i] - ranks[i-1] !== 1) return false;
      }
      return true;
    };

    // åˆ¤æ–­æ˜¯å¦åŒèŠ±
    const isFlush = () => new Set(suits).size === 1;

    const counts = countRanks();
    const straight = isStraight();
    const flush = isFlush();

    // ç‰Œå‹åˆ¤æ–­
    if (flush && straight) {
      return { type: 9, name: 'åŒèŠ±é¡º', ranks }; // åŒèŠ±é¡º
    } else if (counts[0] === 4) {
      return { type: 8, name: 'å››æ¡', ranks };    // å››æ¡
    } else if (counts[0] === 3 && counts[1] === 2) {
      return { type: 7, name: 'è‘«èŠ¦', ranks };    // è‘«èŠ¦
    } else if (flush) {
      return { type: 6, name: 'åŒèŠ±', ranks };    // åŒèŠ±
    } else if (straight) {
      return { type: 5, name: 'é¡ºå­', ranks };    // é¡ºå­
    } else if (counts[0] === 3) {
      return { type: 4, name: 'ä¸‰æ¡', ranks };     // ä¸‰æ¡
    } else if (counts[0] === 2 && counts[1] === 2) {
      return { type: 3, name: 'ä¸¤å¯¹', ranks };    // ä¸¤å¯¹
    } else if (counts[0] === 2) {
      return { type: 2, name: 'ä¸€å¯¹', ranks };     // ä¸€å¯¹
    } else {
      return { type: 1, name: 'é«˜ç‰Œ', ranks };     // é«˜ç‰Œ
    }
  };

  // ================== æ¯”è¾ƒèƒœè´Ÿ ==================
  compareHands(playerHand, dealerHand) {
    const p = this.evaluateHand(playerHand);
    const d = this.evaluateHand(dealerHand);

    // æ¯”è¾ƒç‰Œå‹ç­‰çº§
    if (p.type > d.type) return p.type+'ç©å®¶èƒœ';
    if (p.type < d.type) return d.type+'åº„å®¶èƒœ';

    // ç‰Œå‹ç›¸åŒæ—¶æ¯”è¾ƒå…·ä½“ç‚¹æ•°
    const compareRanks = (a, b) => {
      // å¤„ç†A-2-3-4-5é¡ºå­çš„ç‰¹æ®Šæƒ…å†µ
      if (a.ranks.join(',') === '2,3,4,5,14') a.ranks = [1,2,3,4,5];
      if (b.ranks.join(',') === '2,3,4,5,14') b.ranks = [1,2,3,4,5];
      
      for (let i = a.ranks.length - 1; i >= 0; i--) {
        if (a.ranks[i] > b.ranks[i]) return 'ç©å®¶èƒœ';
        if (a.ranks[i] < b.ranks[i]) return 'åº„å®¶èƒœ';
      }
      return 'å¹³å±€';
    };

    return compareRanks(p, d);
  };
      // ================== ç¤ºä¾‹å¯¹å±€ ==================
  // demoGame() {
  //   const game = new ShowHandGame();
  //   game.initGame();
    
  //   // æ¨¡æ‹Ÿå‘ç‰Œï¼ˆé¢„è®¾ç‰Œç»„ç”¨äºæ¼”ç¤ºï¼‰
  //   game.players = [
  //     new Card('â™ ', 14), // A
  //     new Card('â™¦', 13), // K
  //     new Card('â™¥', 12), // Q
  //     new Card('â™£', 10),
  //     new Card('â™ ', 8)
  //   ];
    
  //   game.dealer = [
  //     new Card('â™¥', 11), // J
  //     new Card('â™¦', 11), // J
  //     new Card('â™£', 9),
  //     new Card('â™¥', 9),
  //     new Card('â™£', 11) // J
  //   ];

  //   console.log('ç©å®¶ç‰Œå‹:', ShowHandGame.evaluateHand(game.players).name);
  //   console.log('åº„å®¶ç‰Œå‹:', ShowHandGame.evaluateHand(game.dealer).name);
  //   console.log('ç»“æœ:', ShowHandGame.compareHands(game.players, game.dealer));
  // };
};


// ================== åˆå§‹åŒ–æ¸¸æˆ ==================
let game = new ShowHandGame();

game.initGame();


</script>

</body>
</html>